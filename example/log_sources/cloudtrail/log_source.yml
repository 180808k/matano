name: "cloudtrail"

ingest:
  expand_records_from_payload: parse_json!(.__raw).Records

transform: # TODO: ts handling... file, source...
  |
    _date, err = to_timestamp(.json.eventTime)
    if err == null {
        .ts = to_unix_timestamp(_date, "milliseconds")
    }

    .aws.cloudtrail.event_version = del(.json.eventVersion)
    .aws.cloudtrail.user_identity.type = del(.json.userIdentity.type)
    if .json.userIdentity.userName != null {
        .related.user = push(.related.user, .json.userIdentity.userName)
    }
    .user.name = del(.json.userIdentity.userName)
    .user.id = del(.json.userIdentity.principalId)
    .aws.cloudtrail.user_identity.arn = del(.json.userIdentity.arn)
    .cloud.account.id = del(.json.userIdentity.accountId)
    .aws.cloudtrail.user_identity.access_key_id = del(.json.userIdentity.accessKeyId)
    .aws.cloudtrail.user_identity.session_context.mfa_authenticated = del(.json.userIdentity.sessionContext.attributes.mfaAuthenticated)

    _date, err = to_timestamp(.json.userIdentity.sessionContext.attributes.creationDate)
    if err == null {
        .aws.cloudtrail.user_identity.session_context.creation_date = to_unix_timestamp(_date, "milliseconds")
    }
    .aws.cloudtrail.user_identity.session_context.session_issuer.type = del(.json.userIdentity.sessionContext.sessionIssuer.type)
    .user.name = del(.json.userIdentity.sessionContext.sessionIssuer.userName)
    .aws.cloudtrail.user_identity.session_context.session_issuer.principal_id = del(.json.userIdentity.sessionContext.sessionIssuer.principalId)
    .aws.cloudtrail.user_identity.session_context.session_issuer.arn = del(.json.userIdentity.sessionContext.sessionIssuer.arn)
    .aws.cloudtrail.user_identity.session_context.session_issuer.account_id = del(.json.userIdentity.sessionContext.sessionIssuer.accountId)
    .aws.cloudtrail.user_identity.invoked_by = del(.json.userIdentity.invokedBy)
    .event.provider = del(.json.eventSource)
    .event.action = .json.eventName
    .aws.cloudtrail.event_category = del(.json.eventCategory)
    .cloud.region = del(.json.awsRegion)
    .source.address = del(.json.sourceIPAddress)

    _grokked, err = parse_groks(.source.address, ["^%{IP:source.ip}$"])
    if err == null {
        . |= _grokked
        .related.user = array!(.related.user)
        .related.ip = array!(.related.ip)
        .related.hash = array!(.related.hash)
    }
    .source.as.number = del(.source.as.asn)
    .source.as.organization.name = del(.source.as.organization_name)
    .user_agent = del(.json.userAgent)
    .aws.cloudtrail.error_code = del(.json.errorCode)
    .aws.cloudtrail.error_message = del(.json.errorMessage)
    .aws.cloudtrail.request_id = del(.json.requestId)
    .event.id = del(.json.eventID)
    .aws.cloudtrail.event_type = del(.json.eventType)
    .aws.cloudtrail.api_version = del(.json.apiVersion)
    .aws.cloudtrail.management_event = del(.json.managementEvent)
    .aws.cloudtrail.read_only = del(.json.readOnly)
    .aws.cloudtrail.resources.arn = del(.json.resources.ARN)
    .aws.cloudtrail.resources.account_id = del(.json.resources.accountId)
    .aws.cloudtrail.resources.type = del(.json.resources.type)
    .aws.cloudtrail.recipient_account_id = del(.json.recipientAccountId)
    .aws.cloudtrail.shared_event_id = del(.json.sharedEventId)
    .aws.cloudtrail.vpc_endpoint_id = del(.json.vpcEndpointId)
    if .aws.cloudtrail.flattened.request_parameters.userName != null {
        .related.user = push(.related.user, .aws.cloudtrail.flattened.request_parameters.userName)
    }
    if .aws.cloudtrail.flattened.request_parameters.newUserName != null {
        .related.user = push(.related.user, .aws.cloudtrail.flattened.request_parameters.newUserName)
    }
    .file.path = del(.json.previousDigestS3Object)
    .file.hash.sha256 = del(.json.previousDigestSignature)
    if .file.hash.sha256 != null {
        push(.related.hash, .file.hash.sha256)
    }
    .aws.cloudtrail.digest.log_files = del(.json.logFiles)

    _date, err = to_timestamp(.json.digestStartTime)
    if err == null {
        .aws.cloudtrail.digest.start_time = to_unix_timestamp(_date, "milliseconds")
    }

    _date, err = to_timestamp(.json.digestEndTime)
    if err == null {
        .ts = to_unix_timestamp(_date, "milliseconds")
    }

    _date, err = to_timestamp(.json.digestEndTime)
    if err == null {
        .aws.cloudtrail.digest.end_time = to_unix_timestamp(_date, "milliseconds")
    }
    .aws.cloudtrail.digest.s3_bucket = del(.json.digestS3Bucket)

    _date, err = to_timestamp(.json.newestEventTime)
    if err == null {
        .aws.cloudtrail.digest.newest_event_time = to_unix_timestamp(_date, "milliseconds")
    }

    _date, err = to_timestamp(.json.oldestEventTime)
    if err == null {
        .aws.cloudtrail.digest.oldest_event_time = to_unix_timestamp(_date, "milliseconds")
    }
    .aws.cloudtrail.digest.previous_s3_bucket = del(.json.previousDigestS3Bucket)
    .aws.cloudtrail.digest.previous_hash_algorithm = del(.json.previousDigestHashAlgorithm)
    .aws.cloudtrail.digest.public_key_fingerprint = del(.json.publicKeyFingerprint)
    .aws.cloudtrail.digest.signature_algorithm = del(.json.digestSignatureAlgorithm)
    .aws.cloudtrail.insight_details = del(.json.insightDetails)
    .group.id = .aws.cloudtrail.flattened.response_elements.group.groupId
    .user.target.id = .aws.cloudtrail.flattened.response_elements.user.userId
    .user.changes.name = .aws.cloudtrail.flattened.request_parameters.newUserName
    .group.name = .aws.cloudtrail.flattened.request_parameters.groupName
    .user.target.name = .aws.cloudtrail.flattened.request_parameters.userName
    .aws.cloudtrail.flattened.digest = del(.aws.cloudtrail.digest)
    .aws.cloudtrail.flattened.insight_details = del(.aws.cloudtrail.insight_details)

schema:
  fields:
    - id: 0
      name: aws
      required: false
      type:
        type: struct
        fields:
          - id: 26
            name: cloudtrail
            required: false
            type:
              type: struct
              fields:
                - id: 18
                  name: error_code
                  required: false
                  type: string
                - id: 19
                  name: error_message
                  required: false
                  type: string
                - id: 20
                  name: event_type
                  required: false
                  type: string
                - id: 21
                  name: event_version
                  required: false
                  type: string
                - id: 22
                  name: flattened
                  required: false
                  type:
                    type: struct
                    fields:
                      - id: 10
                        name: digest
                        required: false
                        type:
                          type: struct
                          fields: []
                - id: 23
                  name: recipient_account_id
                  required: false
                  type: string
                - id: 24
                  name: resources
                  required: false
                  type:
                    type: struct
                    fields: []
                - id: 25
                  name: user_identity
                  required: false
                  type:
                    type: struct
                    fields:
                      - id: 14
                        name: access_key_id
                        required: false
                        type: string
                      - id: 15
                        name: arn
                        required: false
                        type: string
                      - id: 16
                        name: session_context
                        required: false
                        type:
                          type: struct
                          fields:
                            - id: 11
                              name: creation_date
                              required: false
                              type: long
                            - id: 12
                              name: mfa_authenticated
                              required: false
                              type: string
                            - id: 13
                              name: session_issuer
                              required: false
                              type:
                                type: struct
                                fields: []
                      - id: 17
                        name: type
                        required: false
                        type: string
    - id: 1
      name: cloud
      required: false
      type:
        type: struct
        fields:
          - id: 28
            name: account
            required: false
            type:
              type: struct
              fields:
                - id: 27
                  name: id
                  required: false
                  type: string
          - id: 29
            name: region
            required: false
            type: string
    - id: 2
      name: event
      required: false
      type:
        type: struct
        fields:
          - id: 30
            name: action
            required: false
            type: string
          - id: 31
            name: id
            required: false
            type: string
          - id: 32
            name: provider
            required: false
            type: string
    - id: 3
      name: file
      required: false
      type:
        type: struct
        fields:
          - id: 33
            name: hash
            required: false
            type:
              type: struct
              fields: []
    - id: 4
      name: group
      required: false
      type:
        type: struct
        fields: []
    - id: 5
      name: related
      required: false
      type:
        type: struct
        fields:
          - id: 35
            name: user
            required: false
            type:
              type: list
              element-id: 34
              element: string
              element-required: false
    - id: 6
      name: source
      required: false
      type:
        type: struct
        fields:
          - id: 37
            name: as
            required: false
            type:
              type: struct
              fields:
                - id: 36
                  name: organization
                  required: false
                  type:
                    type: struct
                    fields: []
          - id: 38
            name: ip
            required: false
            type: string
    - id: 7
      name: ts
      required: false
      type: long
    - id: 8
      name: user
      required: false
      type:
        type: struct
        fields:
          - id: 39
            name: changes
            required: false
            type:
              type: struct
              fields: []
          - id: 40
            name: id
            required: false
            type: string
          - id: 41
            name: target
            required: false
            type:
              type: struct
              fields: []
    - id: 9
      name: user_agent
      required: false
      type: string
